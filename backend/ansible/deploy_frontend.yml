- name: Configure webserver
  hosts: webservers
  remote_user: root
  become: yes
  become_method: sudo

  tasks:
  
    - name: Upgrade packages
      apt:
        update_cache: true
        upgrade: yes
        lock_timeout: 180
  
    - name: Copy frontend files
      copy:
        src: /var/lib/jenkins/workspace/Resume/frontend/
        dest: /srv/frontend/
        force: true

    - name: Set frontend folder permissions
      file:
        path: /srv/frontend
        recurse: yes
        mode: "0770"
        owner: www-data
        group: www-data

    - name: Copy nginx.conf
      copy:
        src: /var/lib/jenkins/workspace/Resume/backend/nginx.conf
        dest: /etc/nginx
        force: true

    - name: Copy flaskapp.service
      copy:
        src: /var/lib/jenkins/workspace/Resume/backend/flaskapp.service
        dest: /etc/systemd/system
        force: true

    - name: Install pip
      apt:
        name: python3-pip
        state: present

    - name: Install Flask
      pip:
        name: flask
        state: present

    - name: Install uwsgi
      pip:
        name: uwsgi
        state: present

    - name: Install nfs-common package
      apt:
        name: nfs-common
        state: present

    - name: Mount NFS share
      mount:
        name: /mnt/nfs
        src: "192.168.69.200:/volume1/resume-db"
        fstype: nfs
        opts: defaults
        state: mounted
      notify:
        - Set permissions on mount point
        - Set permissions on database

    - name: Install certbot
      apt:
        name: certbot
        state: present
      apt:
        name: python3-certbot-nginx
        state: present

    - name: Obtain SSL Certificates with Certbot
      command: certbot --nginx --agree-tos --redirect --non-interactive --email jon@jon-polansky.com -d resume-dev.jon-polansky.com
      register: certbot_output
      ignore_errors: yes

    - name: Show Certbot Output
      debug:
        var: certbot_output

    - name: Add Certbot Renewal Cron Job
      cron:
        name: "Renew SSL Certificates with Certbot"
        minute: "0"
        hour: "*/12"
        job: "certbot renew --quiet"

    - name: Run flaskapp service
      service:
        name: flaskapp
        state: restarted
        enabled: true

    - name: Reload systemctl daemon
      command:
        cmd: systemctl daemon-reload

    - name: Reload nginx
      service:
        name: nginx
        state: reloaded
        enabled: true

  handlers:
    - name: Set permissions on mount point
      file:
        path: /mnt/nfs
        state: directory
        owner: www-data
        group: www-data
        mode: "0770"

    - name: Set permissions on database
      file:
        path: /mnt/nfs/visitors.db
        owner: www-data
        group: www-data
        mode: "0770"

